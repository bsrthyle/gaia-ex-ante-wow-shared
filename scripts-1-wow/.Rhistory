# running function
acidic_cropland <- calc_acidic_cropland(country_iso3='KEN')
View(acidic_cropland)
sum(acidic_cropland$total_ha)
sum(aa$total)
# data preparations
soils <- terra::aggregate(terra::rast(paste0(input_path, 'soilgrids_properties_cropland.tif')), 10, mean, na.rm=T)
crop_area <- terra::rast(paste0(input_path, "spam_harv_area_processed.tif"))
crop_area_total <- sum(crop_area, na.rm=T)
l_ph_h_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat >= 10, 1, NA); names(l_ph_h_hp) <- 'l_ph_h_hp'
l_ph_l_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat < 10, 1, NA); names(l_ph_l_hp) <- 'l_ph_l_hp'
h_ph_h_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat >= 10, 1, NA); names(h_ph_h_hp) <- 'h_ph_h_hp'
h_ph_l_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat < 10, 1, NA); names(h_ph_l_hp) <- 'h_ph_l_hp'
acid_soil1 <- c(l_ph_h_hp, l_ph_l_hp, h_ph_h_hp, h_ph_l_hp)
l_ph_h_hp_ha <- l_ph_h_hp * crop_area_total
l_ph_l_hp_ha <- l_ph_l_hp * crop_area_total
h_ph_h_hp_ha <- h_ph_h_hp * crop_area_total
h_ph_l_hp_ha <- h_ph_l_hp * crop_area_total
acid_soil2 <- c(l_ph_h_hp_ha, l_ph_l_hp_ha, h_ph_h_hp_ha, h_ph_l_hp_ha)
l_ph_h_hp_ha_crop <- crop_area * l_ph_h_hp; names(l_ph_h_hp_ha_crop) <- paste0(names(l_ph_h_hp_ha_crop), '_l_ph_h_hp')
l_ph_l_hp_ha_crop <- crop_area * l_ph_l_hp; names(l_ph_l_hp_ha_crop) <- paste0(names(l_ph_l_hp_ha_crop), '_l_ph_l_hp')
h_ph_h_hp_ha_crop <- crop_area * h_ph_h_hp; names(h_ph_h_hp_ha_crop) <- paste0(names(h_ph_h_hp_ha_crop), '_h_ph_h_hp')
h_ph_l_hp_ha_crop <- crop_area * h_ph_l_hp; names(h_ph_l_hp_ha_crop) <- paste0(names(h_ph_l_hp_ha_crop), '_h_ph_l_hp')
acid_soil3 <- c(l_ph_h_hp_ha_crop, l_ph_l_hp_ha_crop, h_ph_h_hp_ha_crop, h_ph_l_hp_ha_crop)
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
aa$total <- rowSums(aa[c(15:106)], na.rm=T)
aa <- aa[c('NAME_2', 'total')]
sum(aa$total)
sum(acidic_cropland$total_ha)
acidic_cropland
View(acidic_cropland)
ab <- aggregate(acidic_cropland$total_ha, by=list('NAME_1'=acidic_cropland$NAME_1), FUN=sum, na.rm=T)
acidic_cropland
ab <- aggregate(acidic_cropland$total_ha, by=list('NAME_1'=acidic_cropland$amin1), FUN=sum, na.rm=T)
ab <- aggregate(acidic_cropland$total_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
View(ab)
ab <- aggregate(acidic_cropland$high_hp_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
View(ab)
ab
View(ab)
cty$NAME_2
admin <- 'Kakamega'
admin
zone <- subset(cty, cty$NAME_2==admin)
zone
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
zone
admin <- 'Kakamega'
cty
unique(cty$NAME_2)
admin <- 'Vihiga'
zone <- subset(cty, cty$NAME_2==admin)
terra::plot(zone)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
qed
qed[[1]]
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
table_df
area_calc <- lapply(unique(cty$NAME_2), function(admin){
admin <- 'Vihiga'
unique(cty$NAME_2)
zone <- subset(cty, cty$NAME_2==admin)
terra::plot(zone)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
table_spam <- rbind(table_spam, table_df) })
table_spam <- rbind(table_spam, table_df)
table_spam
area_calc
table_spam <- do.call(rbind, area_calc)
table_spam
table_spam[is.na(table_spam)] <- 0
names(table_spam)
ncol(table_spam)
table_spam[c(4:ncol(table_spam))]
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# most acidic admins
table_spam$high_hp_ha <- table_spam$l_ph_h_hp_qed_ha + table_spam$h_ph_h_hp_qed_ha
table_spam$high_hp_perc <- round(100 * table_spam$high_hp_ha / table_spam$total_ha, 1)
table_spam <- table_spam[order(table_spam$high_hp_perc, decreasing=T),]
table_spam
# function to calculate acidic cropland per admin unit
calc_acidic_cropland <- function(country_iso3){
# select country
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
# calculate cropland per admin unit
table_spam <- data.frame()
area_calc <- lapply(unique(cty$NAME_2), function(admin){
zone <- subset(cty, cty$NAME_2==admin)
terra::plot(zone)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
table_spam <- rbind(table_spam, table_df) })
table_spam <- do.call(rbind, area_calc)
table_spam[is.na(table_spam)] <- 0
names(table_spam)
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# most acidic admins
table_spam$high_hp_ha <- table_spam$l_ph_h_hp_qed_ha + table_spam$h_ph_h_hp_qed_ha
table_spam$high_hp_perc <- round(100 * table_spam$high_hp_ha / table_spam$total_ha, 1)
table_spam <- table_spam[order(table_spam$high_hp_perc, decreasing=T),]
return(table_spam) }
# running function
acidic_cropland <- calc_acidic_cropland(country_iso3='KEN')
acidic_cropland
sum(acidic_cropland$total_ha)
ab <- aggregate(acidic_cropland$high_hp_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
View(ab)
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
View(aa)
sum(acidic_cropland$total_ha)
sum(aa$total)
sum(aa$total, na.rm=T)
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
aa
View(aa)
names(aa)
aa$total <- rowSums(aa[(15:106)], na.rm=T)
sum(ab$total_ha)
ab <- aggregate(acidic_cropland$high_hp_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
sum(ab$total_ha)
sum(aa$total, na.rm=T)
ab <- aggregate(acidic_cropland$high_hp_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
ab
sum(ab$total_ha)
sum(ab$total_ha, na.rm=T)
ab <- aggregate(acidic_cropland$total_ha, by=list('NAME_1'=acidic_cropland$admin1), FUN=sum, na.rm=T)
ab
sum(ab$x, na.rm=T)
sum(aa$total, na.rm=T)
unique(cty$NAME_2)
df <- data.frame(cty[c('NAME_1', 'NAME_2')])
View(df)
length(df)
nrow(df)
df <- data.frame(cty[c('NAME_2')])
df <- unique(data.frame(cty[c('NAME_2')]))
nrow(df)
unique(cty$NAME_1, cty$NAME_2)
names(acid_soil2)
# function to calculate acidic cropland per admin unit
table_spam <- data.frame()
# function to calculate acidic cropland per admin unit
table_spam <- data.frame()
calc_acidic_cropland <- function(country_iso3){
# select country
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
# calculate cropland per admin unit
area_calc <- lapply(unique(cty$NAME_2), function(admin){
# control for admin 1 --------
zone <- subset(cty, cty$NAME_2==admin)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
table_spam <- rbind(table_spam, table_df)
})
table_spam <- do.call(rbind, area_calc)
table_spam[is.na(table_spam)] <- 0
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# most acidic admins
table_spam$high_hp_ha <- table_spam$l_ph_h_hp_qed_ha + table_spam$h_ph_h_hp_qed_ha
table_spam$high_hp_perc <- round(100 * table_spam$high_hp_ha / table_spam$total_ha, 1)
table_spam <- table_spam[order(table_spam$high_hp_perc, decreasing=T),]
return(table_spam) }
# running function
acidic_cropland <- calc_acidic_cropland(country_iso3='KEN')
sum(acidic_cropland$total_ha)
acidic_cropland
calc_acidic_cropland <- function(country_iso3){
# select country
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
# calculate cropland per admin unit
area_calc <- lapply(unique(cty$NAME_2), function(admin){
# control for admin 1 --------
zone <- subset(cty, cty$NAME_2==admin)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
# table_spam <- rbind(table_spam, table_df)
})
table_spam <- do.call(rbind, area_calc)
table_spam[is.na(table_spam)] <- 0
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# most acidic admins
table_spam$high_hp_ha <- table_spam$l_ph_h_hp_qed_ha + table_spam$h_ph_h_hp_qed_ha
table_spam$high_hp_perc <- round(100 * table_spam$high_hp_ha / table_spam$total_ha, 1)
table_spam <- table_spam[order(table_spam$high_hp_perc, decreasing=T),]
return(table_spam) }
# running function
acidic_cropland <- calc_acidic_cropland(country_iso3='KEN')
sum(acidic_cropland$total_ha)
# select country
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
# calculate cropland per admin unit
area_calc <- lapply(unique(cty$NAME_2), function(admin){
# control for admin 1 --------
zone <- subset(cty, cty$NAME_2==admin)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
# table_spam <- rbind(table_spam, table_df)
})
area_calc
table_spam <- do.call(rbind, area_calc)
View(table_spam)
table_spam[is.na(table_spam)] <- 0
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# ------------------------------------------------------------------------------
# directories
# ------------------------------------------------------------------------------
input_path <- paste0(here::here(), '/data-input/')
output_path <- paste0(here::here(), '/data-output/')
# ------------------------------------------------------------------------------
# acidic cropland
# ------------------------------------------------------------------------------
# data preparations
soils <- terra::aggregate(terra::rast(paste0(input_path, 'soilgrids_properties_cropland.tif')), 10, mean, na.rm=T)
crop_area <- terra::rast(paste0(input_path, "spam_harv_area_processed.tif"))
crop_area_total <- sum(crop_area, na.rm=T)
l_ph_h_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat >= 10, 1, NA); names(l_ph_h_hp) <- 'l_ph_h_hp'
l_ph_l_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat < 10, 1, NA); names(l_ph_l_hp) <- 'l_ph_l_hp'
h_ph_h_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat >= 10, 1, NA); names(h_ph_h_hp) <- 'h_ph_h_hp'
h_ph_l_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat < 10, 1, NA); names(h_ph_l_hp) <- 'h_ph_l_hp'
acid_soil1 <- c(l_ph_h_hp, l_ph_l_hp, h_ph_h_hp, h_ph_l_hp)
l_ph_h_hp_ha <- l_ph_h_hp * crop_area_total
l_ph_l_hp_ha <- l_ph_l_hp * crop_area_total
h_ph_h_hp_ha <- h_ph_h_hp * crop_area_total
h_ph_l_hp_ha <- h_ph_l_hp * crop_area_total
acid_soil2 <- c(l_ph_h_hp_ha, l_ph_l_hp_ha, h_ph_h_hp_ha, h_ph_l_hp_ha)
l_ph_h_hp_ha_crop <- crop_area * l_ph_h_hp; names(l_ph_h_hp_ha_crop) <- paste0(names(l_ph_h_hp_ha_crop), '_l_ph_h_hp')
l_ph_l_hp_ha_crop <- crop_area * l_ph_l_hp; names(l_ph_l_hp_ha_crop) <- paste0(names(l_ph_l_hp_ha_crop), '_l_ph_l_hp')
h_ph_h_hp_ha_crop <- crop_area * h_ph_h_hp; names(h_ph_h_hp_ha_crop) <- paste0(names(h_ph_h_hp_ha_crop), '_h_ph_h_hp')
h_ph_l_hp_ha_crop <- crop_area * h_ph_l_hp; names(h_ph_l_hp_ha_crop) <- paste0(names(h_ph_l_hp_ha_crop), '_h_ph_l_hp')
acid_soil3 <- c(l_ph_h_hp_ha_crop, l_ph_l_hp_ha_crop, h_ph_h_hp_ha_crop, h_ph_l_hp_ha_crop)
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
df <- data.frame(cty[c('NAME_1', 'NAME_2')])
nrow(df)
df <- unique(data.frame(cty[c('NAME_2')]))
# function to calculate acidic cropland per admin unit
calc_acidic_cropland <- function(country_iso3){
# select country
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
# calculate cropland per admin unit
area_calc <- lapply(unique(cty$NAME_2), function(admin){
# ----------------------------
# control for admin 1 --------
# ----------------------------
zone <- subset(cty, cty$NAME_2==admin)
qed <- lapply(names(acid_soil2), function(soillayer){
soil_layer <- acid_soil2[[soillayer]]
soil_layer_area <- terra::global(terra::crop(x=soil_layer, y=zone, mask=T), sum, na.rm=T)
soil_layer_area})
table_df <- data.frame(admin0=unique(zone$COUNTRY), admin1=unique(zone$NAME_1), admin2=unique(zone$NAME_2),
l_ph_h_hp_qed_ha=round(qed[[1]]$sum, 1), l_ph_l_hp_qed_ha=round(qed[[2]]$sum, 1),
h_ph_h_hp_qed_ha=round(qed[[3]]$sum, 1), h_ph_l_hp_qed_ha=round(qed[[4]]$sum, 1))
})
table_spam <- do.call(rbind, area_calc)
table_spam[is.na(table_spam)] <- 0
table_spam$total_ha <- rowSums(table_spam[c(4:ncol(table_spam))], na.rm=T)
# most acidic admins
table_spam$high_hp_ha <- table_spam$l_ph_h_hp_qed_ha + table_spam$h_ph_h_hp_qed_ha
table_spam$high_hp_perc <- round(100 * table_spam$high_hp_ha / table_spam$total_ha, 1)
table_spam <- table_spam[order(table_spam$high_hp_perc, decreasing=T),]
return(table_spam) }
# running function
acidic_cropland <- calc_acidic_cropland(country_iso3='KEN')
sum(acidic_cropland$total_ha)
acid_soil2 <- crop_area_total * acid_soil1
acid_soil2
acid_soil2 <- acid_soil1 * crop_area_total
acid_soil2
acid_soil2 <- c(l_ph_h_hp_ha, l_ph_l_hp_ha, h_ph_h_hp_ha, h_ph_l_hp_ha)
acid_soil2
library(akima)
library(sjPlot)
library(ggplot2)
theme_set(theme_sjplot())
# ------------------------------------------------------------------------------
# start here
# ------------------------------------------------------------------------------
dir <- 'D:/# Jvasco/Working Papers/GAIA Guiding Acid Soil Investments/2-yield-response/'
# load data
path <- 'D:/# Jvasco/Working Papers/GAIA Guiding Acid Soil Investments/2-yield-response/#-bisrat-clean/data/final_data/year_1/'
eth <- read.csv(paste0(path, 'gaia_trials_Ethiopia_season1_shotgun.csv'))
tza <- read.csv(paste0(path, 'gaia_trials_tanzania_season1_shotgun.csv'))
rwa <- read.csv(paste0(path, 'gaia_trials_Rwanda_season1_shotgun.csv'))
df <- rbind(eth, tza, rwa)
df$crop <- tolower(df$crop)
df <- unique(df[c("fid", "crop", "treatment", "lime_tha", "yield_tha", "country", "admin2_gadm", "tex", "soc", "ecec", "ex_ac", "ca", "mg", "k", "psi", "hp_sat")])
df <- na.omit(df) # to check how to fill some of the NA's
# maize dataset
maize <- subset(df, crop == 'maize')
## for bisrat to correct --------------------
maize$yield_tha <- round(maize$yield_tha, 3)
maize$treatment <- ifelse(maize$yield_tha==2.052, 'T1', maize$treatment)
str(maize)
maize$country <- as.factor(maize$country)
maize$admin2_gadm <- as.factor(maize$admin2_gadm)
maize$fid <- as.factor(maize$fid)
maize$treatment <- as.factor(maize$treatment)
# reshape data
maize_rshp <- reshape2::dcast(maize, fid + crop + country + admin2_gadm + soc + ecec + psi + ex_ac + hp_sat ~ treatment, value.var='yield_tha')
View(maize_rshp)
maize_rshp$resp_T2 <- maize_rshp$T2 - maize_rshp$T1
maize_rshp$resp_T3 <- maize_rshp$T3 - maize_rshp$T1
maize_rshp$resp_T4 <- maize_rshp$T4 - maize_rshp$T1
maize <- reshape2::melt(maize_rshp[c(1:9,14:16)], id.vars=c("fid", "crop", "country", "admin2_gadm", "soc", "ecec", "psi", "ex_ac", "hp_sat"))
View(maize)
# this is it!!
mod2 <- lmerTest::lmer(value ~ admin2_gadm + variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
mod1 <- lmerTest::lmer(value ~ variable * (soc + ecec + ex_ac + psi) + (1 | admin2_gadm/fid), data=maize, REML=T)
mod0 <- lmerTest::lmer(value ~ variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
anova(mod2, mod1, mod0)
anova(mod1)
mod1 <- lmerTest::lmer(value ~ variable * (soc + ecec + ex_ac + psi) + (1 | country/admin2_gadm/fid), data=maize, REML=T)
mod1 <- lmerTest::lmer(value ~ variable * (soc + ecec + ex_ac + psi) + (1 | admin2_gadm/fid), data=maize, REML=T)
anova(mod1)
anova(mod2)
mod2 <- lmerTest::lmer(value ~ admin2_gadm * variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
anova(mod2)
av <- emmeans::emmeans(mod, ~variable*soc | admin2_gadm)
av <- emmeans::emmeans(mod2, ~variable*soc | admin2_gadm)
av
av <- emmeans::emmeans(mod2, ~variable*soc | admin2_gadm, soc=c(0.5, 1.4))
av
av <- emmeans::emmeans(mod2, ~variable*soc | admin2_gadm, at=list('soc'=c(0.5, 1.4)))
av
anova(mod2)
maize$site_pca <- ifelse(maize$admin2_gadm == 'Jimma', 'cluster1', NA)
maize$site_pca <- ifelse(maize$admin2_gadm == 'Burera' | maize$admin2_gadm == 'Mbozi', 'cluster2', maize$site_pca)
maize$site_pca <- ifelse(maize$admin2_gadm == 'Ngororero' | maize$admin2_gadm == 'Nyaruguru', 'cluster3', maize$site_pca)
maize$site_pca <- ifelse(maize$admin2_gadm == 'Geita', 'cluster4', maize$site_pca)
mod2 <- lmerTest::lmer(value ~ site_pca * variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
anova(mod2)
av <- emmeans::emmeans(mod2, ~variable*soc | site_pca, at=list('soc'=c(0.5, 1.4)))
av
expand.grid(ex_ac, ecec)
ex_ac <- c(quantile(maize$ex_ac, c(0.2, 0.5, 0.8)))
ecec <- c(quantile(maize$ecec, c(0.2, 0.5, 0.8)))
soc <- c(quantile(maize$soc, c(0.2, 0.5, 0.8)))
psi <- c(quantile(maize$psi, c(0.2, 0.5, 0.8)))
expand.grid(ex_ac, ecec)
av_soc
av_soc <- emmeans::emmeans(mod2, ~variable*soc | site_pca, at=list('soc'=c(0.5, 1.4)))
av_soc
av
mod2 <- lmerTest::lmer(value ~ admin2_gadm * variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
anova(mod2)
av <- emmeans::emmeans(mod2, ~variable*soc | admin2_gadm, at=list('soc'=c(0.5, 1.4)))
av
av <- multcomp::cld(av)
av
plot_model(mod2)
av <- emmeans::emmeans(mod2, ~admin2_gadm*soc | variable, at=list('soc'=c(0.5, 1.4)))
av
av <- emmeans::emmeans(mod2, ~variable*soc | admin2_gadm, at=list('soc'=c(0.5, 1.4)))
av <- multcomp::cld(av)
mod2 <- lmerTest::lmer(value ~ admin2_gadm * variable * (soc + ecec + ex_ac + psi) + (1 | fid), data=maize, REML=T)
anova(mod2)
# ------------------------------------------------------------------------------
# directories
# ------------------------------------------------------------------------------
input_path <- paste0(here::here(), '/data-input/')
output_path <- paste0(here::here(), '/data-output/')
# ------------------------------------------------------------------------------
# acidic cropland
# ------------------------------------------------------------------------------
# data preparations
soils <- terra::aggregate(terra::rast(paste0(input_path, 'soilgrids_properties_cropland.tif')), 10, mean, na.rm=T)
crop_area <- terra::rast(paste0(input_path, "spam_harv_area_processed.tif"))
crop_area_total <- sum(crop_area, na.rm=T)
l_ph_h_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat >= 10, 1, NA); names(l_ph_h_hp) <- 'l_ph_h_hp'
l_ph_l_hp <- terra::ifel(soils$ph < 5.5 & soils$hp_sat < 10, 1, NA); names(l_ph_l_hp) <- 'l_ph_l_hp'
h_ph_h_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat >= 10, 1, NA); names(h_ph_h_hp) <- 'h_ph_h_hp'
h_ph_l_hp <- terra::ifel(soils$ph >= 5.5 & soils$hp_sat < 10, 1, NA); names(h_ph_l_hp) <- 'h_ph_l_hp'
acid_soil1 <- c(l_ph_h_hp, l_ph_l_hp, h_ph_h_hp, h_ph_l_hp)
acid_soil2 <- acid_soil1 * crop_area_total
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
l_ph_h_hp_ha_crop <- crop_area * l_ph_h_hp; names(l_ph_h_hp_ha_crop) <- paste0(names(l_ph_h_hp_ha_crop), '_l_ph_h_hp')
l_ph_l_hp_ha_crop <- crop_area * l_ph_l_hp; names(l_ph_l_hp_ha_crop) <- paste0(names(l_ph_l_hp_ha_crop), '_l_ph_l_hp')
h_ph_h_hp_ha_crop <- crop_area * h_ph_h_hp; names(h_ph_h_hp_ha_crop) <- paste0(names(h_ph_h_hp_ha_crop), '_h_ph_h_hp')
h_ph_l_hp_ha_crop <- crop_area * h_ph_l_hp; names(h_ph_l_hp_ha_crop) <- paste0(names(h_ph_l_hp_ha_crop), '_h_ph_l_hp')
acid_soil3 <- c(l_ph_h_hp_ha_crop, l_ph_l_hp_ha_crop, h_ph_h_hp_ha_crop, h_ph_l_hp_ha_crop)
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=2, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
aa[is.na(aa)] <- 0
aa$total <- rowSums(aa[c(15:ncol(aa))], na.rm=T)
sum(aa$total)
aa1 <- terra::crop(x=acid_soil3, y=cty, mask=T)
aa1
terra::global(aa1, sum, na.rm=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
sum(aa2$sum)
acid_soil3
aa1 <- terra::crop(x=acid_soil3, y=cty, mask=T)
aa1
terra::plot(aa1$MAIZ_l_ph_h_hp)
terra::plot(aa1$MAIZ_l_ph_h_hp), terra::plot(cty, add=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(cty, add=T)
aa1 <- terra::crop(x=acid_soil3, y=cty, mask=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(cty, add=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
aa2
sum(aa2$sum)
sum(aa$total)
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=1, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
aa[is.na(aa)] <- 0
aa$total <- rowSums(aa[c(15:ncol(aa))], na.rm=T)
aa
aa$total <- rowSums(aa[c(15:ncol(aa))], na.rm=T)
ab <- aa[c('NAME_1', 'total')]
ab
kakamega <- subset(cty, ctty$NAME_1 == 'Kakamega')
kakamega <- subset(cty, cty$NAME_1 == 'Kakamega')
aa1 <- terra::crop(x=acid_soil3, y=cty, mask=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(cty, add=T)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(kakamega, add=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
sum(aa2$sum)
sum(aa2$sum, na.rm=T)
ac <- cbind(data.frame(kakamega), terra::extract(acid_soil3, kakamega, fun=sum, na.rm=T))
ac
ac$total <- rowSums(ac[c(15:ncol(ac))], na.rm=T)
sum(aa$total)
sum(ac$total)
sum(aa2$sum, na.rm=T)
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=1, path=input_path)
ad <- terra::crop(acid_soil3, kakamega, mask=T)
ad2 <- terra::global(ad1, sum, na.rm=T)
ad2 <- terra::global(ad, sum, na.rm=T)
sum(ad2$sum, na.rm=T)
sum(ac$total)
sum(aa2$sum, na.rm=T)
country_iso3 <- 'KEN'
cty <- geodata::gadm(country_iso3, level=1, path=input_path)
aa <- cbind(data.frame(cty), terra::extract(acid_soil3, cty, fun=sum, na.rm=T))
aa[is.na(aa)] <- 0
aa$total <- rowSums(aa[c(15:ncol(aa))], na.rm=T)
sum(aa$total)
ab <- aa[c('NAME_1', 'total')]
ab
kakamega <- subset(cty, cty$NAME_1 == 'Kakamega')
ac <- cbind(data.frame(kakamega), terra::extract(acid_soil3, kakamega, fun=sum, na.rm=T))
ac$total <- rowSums(ac[c(15:ncol(ac))], na.rm=T)
sum(ac$total)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
sum(aa2$sum, na.rm=T)
for(county in unique(cty$NAME_1)){
kakamega <- subset(cty, cty$NAME_1 ==county)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
print(paste0(county, '//', sum(aa2$sum, na.rm=T)))
}
?terra::crop
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T)
terra::plot(aa1); terra::plot(kakamega, add=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(kakamega, add=T)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T, touches=T)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(kakamega, add=T)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T, touches=F)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(kakamega, add=T)
for(county in unique(cty$NAME_1)){
kakamega <- subset(cty, cty$NAME_1 ==county)
aa1 <- terra::crop(x=acid_soil3, y=kakamega, mask=T, touches=F)
terra::plot(aa1$MAIZ_l_ph_h_hp); terra::plot(kakamega, add=T)
aa2 <- terra::global(aa1, sum, na.rm=T)
print(paste0(county, '//', sum(aa2$sum, na.rm=T)))
}
